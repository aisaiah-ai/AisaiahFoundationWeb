name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggers

# Prevent multiple deployments from running simultaneously
concurrency:
  group: cloudflare-pages-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Deploy to Cloudflare Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify Build Output
        run: |
          if [ ! -d "dist/public" ]; then
            echo "Build output directory not found!"
            exit 1
          fi
          echo "Build output verified:"
          ls -la dist/public/ | head -20
          echo ""
          echo "Checking for key files:"
          ls -la dist/public/index.html || echo "âš ï¸ index.html not found!"
          ls -la dist/public/_redirects || echo "âš ï¸ _redirects not found!"
          ls -la dist/public/_headers || echo "âš ï¸ _headers not found!"
          echo ""
          echo "Build timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Verify Wrangler Installation
        run: wrangler --version

      - name: Check if Project Exists
        id: check_project
        run: |
          echo "Checking for existing Cloudflare Pages project..."
          set +e  # Don't exit on error
          PROJECT_LIST=$(wrangler pages project list 2>&1)
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ] && echo "$PROJECT_LIST" | grep -q "aisaiah-foundation-web"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Project exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Project does not exist yet (or error checking: $EXIT_CODE)"
            echo "Project list output:"
            echo "$PROJECT_LIST"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

      - name: Create Project if Needed
        if: steps.check_project.outputs.exists != 'true'
        run: |
          echo "Creating Cloudflare Pages project..."
          set +e  # Don't exit on error
          wrangler pages project create aisaiah-foundation-web \
            --compatibility-date=2024-11-27 \
            --production-branch=main
          CREATE_EXIT=$?
          if [ $CREATE_EXIT -eq 0 ]; then
            echo "âœ… Project created successfully"
          else
            echo "âš ï¸ Project creation returned exit code $CREATE_EXIT (may already exist)"
            # Try to verify it exists now
            sleep 2
            wrangler pages project list | grep "aisaiah-foundation-web" && echo "âœ… Project verified" || echo "âŒ Project still not found"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

      - name: Validate Secrets
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN is not set"
            exit 1
          fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID is not set"
            exit 1
          fi
          echo "âœ… Secrets validated"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        id: deploy
        run: |
          echo "Deploying to Cloudflare Pages..."
          echo "Project: aisaiah-foundation-web"
          echo "Directory: dist/public"
          echo "Branch: main"
          
          DEPLOY_OUTPUT=$(wrangler pages deploy dist/public \
            --project-name=aisaiah-foundation-web \
            --branch=main \
            --commit-hash="${{ github.sha }}" \
            --commit-message="${{ github.event.head_commit.message || 'Deploy from GitHub Actions' }}" 2>&1)
          DEPLOY_EXIT=$?
          
          echo "$DEPLOY_OUTPUT"
          
          if [ $DEPLOY_EXIT -ne 0 ]; then
            echo "âŒ Deployment failed with exit code $DEPLOY_EXIT"
            exit 1
          fi
          
          # Extract deployment URL if available
          if echo "$DEPLOY_OUTPUT" | grep -q "https://"; then
            DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^ ]*' | head -1)
            echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "âœ… Deployment successful: $DEPLOY_URL"
          else
            echo "âœ… Deployment completed"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Configure Custom Domain (Optional)
        if: steps.deploy.outcome == 'success'
        run: |
          echo "Checking for custom domain configuration..."
          # Only add domain if it's not already configured
          # This will fail gracefully if domain is not in Cloudflare or already added
          wrangler pages domain add aisaiah.org \
            --project-name=aisaiah-foundation-web 2>&1 || echo "Domain may already be configured or not available in Cloudflare"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "âœ… **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Message**: ${{ github.event.head_commit.message || 'Deploy from GitHub Actions' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.deploy.outputs.deploy_url }}" ]; then
              echo "ðŸŒ **Pages URL**: ${{ steps.deploy.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Custom Domain**: https://aisaiah.org" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **If you see old content:**" >> $GITHUB_STEP_SUMMARY
            echo "   - Hard refresh: \`Ctrl+Shift+R\` (Windows/Linux) or \`Cmd+Shift+R\` (Mac)" >> $GITHUB_STEP_SUMMARY
            echo "   - Clear browser cache" >> $GITHUB_STEP_SUMMARY
            echo "   - Wait 1-2 minutes for Cloudflare cache to propagate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See SETUP_CUSTOM_DOMAIN.md for instructions on configuring aisaiah.org" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
